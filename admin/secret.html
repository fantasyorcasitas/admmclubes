<script type="module">
    import { db, auth } from "../js/firebase-config.js"; 
    import { 
        collection, addDoc, getDocs, orderBy, query, doc, getDoc, updateDoc, deleteDoc, where 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // === VARIABLES GLOBALES ===
    let listaParticipantes = []; 
    window.listaParticipantes = listaParticipantes; // Hacerla global para el HTML

    // === 1. SEGURIDAD (AUTH) ===
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const docRef = doc(db, "usuarios", user.uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists() && docSnap.data().rol === "admin") {
                console.log("Acceso Admin Autorizado");
                initAdmin();
            } else {
                document.body.innerHTML = "<h1 style='color:white;text-align:center;margin-top:50px;'>‚õî ACCESO DENEGADO</h1>";
                setTimeout(() => window.location.href = "../docs/home.html", 1500);
            }
        } else {
            window.location.href = "../index.html";
        }
    });

    async function initAdmin() {
        cargarSelectoresAtletas();
        cargarSelectorCompes();
        cargarCheckboxesPendientes();
    }

    // =========================================================
    // 2. GESTI√ìN DE ATLETAS (CREAR / EDITAR)
    // =========================================================

    // --- CARGAR ATLETA EN FORMULARIO ---
    document.getElementById('btnCargarAtleta').addEventListener('click', () => {
        const select = document.getElementById('selectorEditarAtleta');
        if(!select.value) return alert("Selecciona un atleta.");
        
        const data = JSON.parse(select.options[select.selectedIndex].getAttribute('data-info'));
        
        // Datos b√°sicos
        document.getElementById('atletaIdHidden').value = select.value;
        document.getElementById('atlNombre').value = data.nombre;
        document.getElementById('atlApellidos').value = data.apellidos;
        document.getElementById('atlCategoria').value = data.categoria;
        document.getElementById('atlPrecio').value = data.precio;
        document.getElementById('atlPruebas').value = data.pruebas_principales || "";
        document.getElementById('atlCatMarcas').value = data.cat_marcas || "u23";
        
        // --- DATOS T√âCNICOS (Nuevos campos) ---
        document.getElementById('atlMarcaPersonal').value = data.marca_personal || "";
        document.getElementById('atlPosicionEsperada').value = data.posicion_esperada || "";
        document.getElementById('atlFechaUltima').value = data.fecha_ultima_competicion || "";
        document.getElementById('atlMarcaUltima').value = data.marca_ultima_competicion || "";
        // --------------------------------------

        document.getElementById('fotoActualHidden').value = data.foto;
        document.getElementById('btnCancelarEdicion').style.display = 'block';
        document.getElementById('btnBorrarAtleta').style.display = 'block';
    });

    // --- GUARDAR ATLETA (SUBMIT) ---
    document.getElementById('formAtleta').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnSubmitAtleta');
        btn.innerText = "Guardando...";
        btn.disabled = true;

        try {
            const id = document.getElementById('atletaIdHidden').value;
            const precio = Number(document.getElementById('atlPrecio').value);
            const fileInput = document.getElementById('atlFotoInput');
            
            // Foto: Si hay nueva usa esa, si no la antigua, si no la default
            let rutaFoto = id ? document.getElementById('fotoActualHidden').value : "https://cdn-icons-png.flaticon.com/512/74/74472.png";
            if (fileInput.files.length > 0) rutaFoto = "../images/" + fileInput.files[0].name;

            const datos = {
                nombre: document.getElementById('atlNombre').value,
                apellidos: document.getElementById('atlApellidos').value,
                categoria: document.getElementById('atlCategoria').value,
                precio: precio,
                pruebas_principales: document.getElementById('atlPruebas').value,
                cat_marcas: document.getElementById('atlCatMarcas').value,
                foto: rutaFoto,

                // --- NUEVOS CAMPOS ---
                marca_personal: document.getElementById('atlMarcaPersonal').value,
                posicion_esperada: Number(document.getElementById('atlPosicionEsperada').value) || 0,
                fecha_ultima_competicion: document.getElementById('atlFechaUltima').value,
                marca_ultima_competicion: document.getElementById('atlMarcaUltima').value
                // ---------------------
            };

            if (id) {
                // EDITAR
                await updateDoc(doc(db, "atletas", id), datos);
                alert("‚úÖ Atleta actualizado correctamente");
            } else {
                // CREAR NUEVO (Init valores extra)
                datos.puntos = 0;
                datos.tendencia = "neutral";
                datos.historial_puntos = [];
                datos.historial_valor = [precio];
                await addDoc(collection(db, "atletas"), datos);
                alert("‚úÖ Nuevo atleta creado");
            }
            window.location.reload();

        } catch (error) {
            console.error(error);
            alert("Error al guardar: " + error.message);
            btn.disabled = false;
            btn.innerText = "GUARDAR";
        }
    });

    // =========================================================
    // 3. CARGA DE SELECTORES (Data)
    // =========================================================
    async function cargarSelectoresAtletas() {
        try {
            const q = query(collection(db, "atletas"), orderBy("nombre"));
            const snap = await getDocs(q);
            let html = '<option value="">-- Selecciona --</option>';
            snap.forEach((doc) => {
                const d = doc.data();
                const safeData = JSON.stringify(d).replace(/"/g, '&quot;');
                html += `<option value="${doc.id}" data-info="${safeData}">${d.nombre} ${d.apellidos}</option>`;
            });
            document.getElementById('selectorEditarAtleta').innerHTML = html;
            document.getElementById('selectorAtletasLineup').innerHTML = html;
        } catch(e) { console.error(e); }
    }

    async function cargarSelectorCompes() {
        try {
            const q = query(collection(db, "competiciones"), orderBy("fecha", "desc"));
            const snap = await getDocs(q);
            let html = '<option value="">-- Editar Competici√≥n --</option>';
            snap.forEach((doc) => {
                const d = doc.data();
                const safeData = JSON.stringify(d).replace(/"/g, '&quot;');
                const icon = d.estado === 'finalizada' ? '‚úÖ' : '‚è≥';
                html += `<option value="${doc.id}" data-info="${safeData}">${icon} ${d.fecha} - ${d.nombre}</option>`;
            });
            document.getElementById('selectorEditarCompe').innerHTML = html;
        } catch(e) { console.error(e); }
    }

    // =========================================================
    // 4. GESTI√ìN DE COMPETICIONES
    // =========================================================
    
    // Cargar Competici√≥n existente
    document.getElementById('btnCargarCompe').addEventListener('click', () => {
        const select = document.getElementById('selectorEditarCompe');
        if(!select.value) return alert("Selecciona competici√≥n");
        
        const data = JSON.parse(select.options[select.selectedIndex].getAttribute('data-info'));
        document.getElementById('compeIdHidden').value = select.value;
        document.getElementById('compNombre').value = data.nombre;
        document.getElementById('compFecha').value = data.fecha;
        document.getElementById('compLugar').value = data.lugar;
        document.getElementById('compEstado').value = data.estado || "pendiente";
        document.getElementById('compLinks').value = data.links || "";
        document.getElementById('compPruebas').value = data.pruebas_resumen || "";
        
        window.listaParticipantes = data.participantes || [];
        actualizarVisualCompe();
        
        document.getElementById('btnCancelarCompe').style.display = 'block';
        document.getElementById('btnBorrarCompe').style.display = 'block';
    });

    // A√±adir Atleta a la Lista (Memoria)
    document.getElementById('btnAddLineup').addEventListener('click', () => {
        const selector = document.getElementById('selectorAtletasLineup');
        const prueba = document.getElementById('inputPruebaEspecifica').value;
        const mp = document.getElementById('inputMarcaPersonal').value;
        const pos = document.getElementById('inputPosicionEsperada').value;

        if (!selector.value || !prueba) return alert("Falta Atleta o Prueba");

        window.listaParticipantes.push({
            id_atleta: selector.value,
            nombre_completo: selector.options[selector.selectedIndex].text,
            prueba: prueba,
            marca_personal: mp,
            posicion_esperada: pos,
            resultado: "",
            puntos: 0
        });

        // Limpiar inputs r√°pidos
        document.getElementById('inputPruebaEspecifica').value = "";
        document.getElementById('inputMarcaPersonal').value = "";
        document.getElementById('inputPosicionEsperada').value = "";
        
        actualizarVisualCompe();
    });

    function actualizarVisualCompe() {
        const container = document.getElementById('listaVisual');
        container.innerHTML = window.listaParticipantes.length ? "" : '<p style="color:#666;text-align:center;">Lista vac√≠a.</p>';
        
        window.listaParticipantes.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'lineup-item';
            div.dataset.id = item.id_atleta;
            div.style.cssText = "display:flex; align-items:center; gap:10px; border-bottom:1px solid #333; padding:10px; background:#151515; margin-bottom:5px;";
            
            div.innerHTML = `
                <div style="flex-grow:1;">
                    <strong style="color:white;">${item.nombre_completo}</strong> <span style="color:#888; font-size:0.8rem;">(${item.prueba})</span>
                </div>
                <input type="text" class="result-text" placeholder="Res" value="${item.resultado||''}" oninput="window.listaParticipantes[${index}].resultado=this.value">
                <input type="number" class="result-points" placeholder="Pts" value="${item.puntos||0}" oninput="window.listaParticipantes[${index}].puntos=Number(this.value)">
                <i class="fa-solid fa-trash" style="color:red; cursor:pointer;" onclick="delLineup(${index})"></i>
            `;
            container.appendChild(div);
        });
    }

    window.delLineup = (index) => {
        window.listaParticipantes.splice(index, 1);
        actualizarVisualCompe();
    };

    // GUARDAR COMPETICI√ìN (SUBMIT)
    document.getElementById('formCompe').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnSubmitCompe');
        btn.disabled = true; btn.innerText = "Guardando...";

        try {
            const id = document.getElementById('compeIdHidden').value;
            
            // Sincronizar inputs visuales con array
            const domItems = document.querySelectorAll('.lineup-item');
            const listaFinal = [];
            domItems.forEach((div, i) => {
                const inputs = div.querySelectorAll('input');
                const pOriginal = window.listaParticipantes[i];
                listaFinal.push({
                    ...pOriginal,
                    resultado: inputs[0].value,
                    puntos: Number(inputs[1].value)
                });
            });

            const datosCompe = {
                nombre: document.getElementById('compNombre').value,
                fecha: document.getElementById('compFecha').value,
                lugar: document.getElementById('compLugar').value,
                estado: document.getElementById('compEstado').value,
                links: document.getElementById('compLinks').value,
                pruebas_resumen: document.getElementById('compPruebas').value,
                participantes: listaFinal
            };

            if(id) await updateDoc(doc(db, "competiciones", id), datosCompe);
            else await addDoc(collection(db, "competiciones"), datosCompe);

            // ACTUALIZAR MMP/POS EN FICHA DE ATLETA (SI SE INTRODUJO EN LA COMPE)
            const promesas = listaFinal.map(async (p) => {
                const updateData = {};
                if(p.marca_personal) updateData.marca_personal = p.marca_personal;
                if(p.posicion_esperada) updateData.posicion_esperada = Number(p.posicion_esperada);
                
                if(Object.keys(updateData).length > 0) {
                    await updateDoc(doc(db, "atletas", p.id_atleta), updateData);
                }
            });
            await Promise.all(promesas);

            alert("‚úÖ Competici√≥n guardada.");
            window.location.reload();
        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
            btn.disabled = false;
        }
    });

    // =========================================================
    // 5. CIERRE DE JORNADA (L√ìGICA PUNTOS)
    // =========================================================
    async function cargarCheckboxesPendientes() {
        const container = document.getElementById('checklistCompes');
        try {
            const q = query(collection(db, "competiciones"), orderBy("fecha", "asc"));
            const snap = await getDocs(q);
            let html = '';
            let hayPendientes = false;

            snap.forEach(doc => {
                const d = doc.data();
                if(d.estado === 'pendiente') {
                    hayPendientes = true;
                    const partStr = JSON.stringify(d.participantes || []).replace(/"/g, '&quot;');
                    html += `
                        <div class="check-item">
                            <label style="display:flex; align-items:center; cursor:pointer;">
                                <input type="checkbox" class="comp-checkbox" value="${doc.id}" data-parts="${partStr}" style="width:20px; height:20px; margin-right:10px;">
                                <span style="color:white;">${d.nombre} (${d.fecha})</span>
                            </label>
                        </div>`;
                }
            });
            container.innerHTML = hayPendientes ? html : '<p style="color:#666;text-align:center">No hay pendientes.</p>';
            if(!hayPendientes && document.getElementById('btnCerrarJornadaGlobal')) {
                document.getElementById('btnCerrarJornadaGlobal').disabled = true;
                document.getElementById('btnCerrarJornadaGlobal').style.opacity = "0.5";
            }
        } catch(e) { console.error(e); }
    }

    document.getElementById('btnCerrarJornadaGlobal').addEventListener('click', async () => {
        const checks = document.querySelectorAll('.comp-checkbox:checked');
        if(checks.length === 0) return alert("Selecciona competiciones");
        if(!confirm("¬øSeguro que quieres cerrar la jornada y repartir puntos?")) return;

        const btn = document.getElementById('btnCerrarJornadaGlobal');
        btn.disabled = true; btn.innerText = "Procesando...";

        try {
            // 1. Mapa de puntos
            const mapaPuntos = {}; 
            const idsCompes = [];

            checks.forEach(cb => {
                idsCompes.push(cb.value);
                const parts = JSON.parse(cb.getAttribute('data-parts'));
                parts.forEach(p => {
                    const pts = Number(p.puntos) || 0;
                    if(pts > 0) mapaPuntos[p.id_atleta] = (mapaPuntos[p.id_atleta] || 0) + pts;
                });
            });

            // 2. Repartir a usuarios
            const usersSnap = await getDocs(collection(db, "usuarios"));
            const promesasUsers = usersSnap.docs.map(async (uDoc) => {
                const u = uDoc.data();
                const equipo = u.equipo || [];
                let suma = 0;
                equipo.forEach(atlId => {
                    let ptsAtl = mapaPuntos[atlId] || 0;
                    if(u.capitanId === atlId) ptsAtl *= 1.5; 
                    suma += ptsAtl;
                });

                if(suma > 0) {
                    await updateDoc(doc(db, "usuarios", uDoc.id), {
                        puntos_total: (u.puntos_total || 0) + suma,
                        puntos_ultima_jornada: suma
                    });
                }
            });
            await Promise.all(promesasUsers);

            // 3. Actualizar Atletas (Historial y Precio)
            const promesasAtletas = Object.keys(mapaPuntos).map(async (atlId) => {
                const pts = mapaPuntos[atlId];
                const atlRef = doc(db, "atletas", atlId);
                const atlSnap = await getDoc(atlRef);
                if(atlSnap.exists()) {
                    const ad = atlSnap.data();
                    let nuevoPrecio = ad.precio;
                    if(pts >= 25) nuevoPrecio++;
                    if(pts <= 5 && nuevoPrecio > 1) nuevoPrecio--;

                    const histP = ad.historial_puntos || []; histP.push(pts);
                    const histV = ad.historial_valor || []; histV.push(nuevoPrecio);

                    await updateDoc(atlRef, {
                        puntos: (ad.puntos || 0) + pts,
                        precio: nuevoPrecio,
                        historial_puntos: histP,
                        historial_valor: histV
                    });
                }
            });
            await Promise.all(promesasAtletas);

            // 4. Cerrar Compes
            const promesasCompes = idsCompes.map(id => updateDoc(doc(db, "competiciones", id), { estado: "finalizada" }));
            await Promise.all(promesasCompes);

            alert("üèÜ Jornada Cerrada Correctamente");
            window.location.reload();

        } catch (e) {
            console.error(e);
            alert("Error cerrando jornada");
            btn.disabled = false;
        }
    });
</script>