<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin | Fantasy Track</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ESTILOS EXTRA ESPEC√çFICOS PARA EL ADMIN */
        html, body { overflow-y: auto !important; height: auto !important; min-height: 100vh; }
        .admin-container { padding-top: 130px !important; padding-bottom: 100px !important; max-width: 1000px; margin: 0 auto; position: relative; z-index: 10; }
        .navbar { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background: #000; border-bottom: 2px solid var(--primary); }
        
        /* Ajustes inputs admin */
        select, input { background: #111 !important; color: white !important; border: 1px solid #555 !important; }
        .result-text { background: #000 !important; border: 1px solid #444 !important; color: #ccc !important; width: 140px; padding: 5px; border-radius: 4px; text-align: center; }
        .result-points { background: #000 !important; border: 1px solid var(--primary) !important; color: var(--primary) !important; width: 70px; padding: 5px; border-radius: 4px; font-weight: bold; text-align: center; }
        
        .btn-delete { background: #d63031 !important; color: white !important; border: none !important; margin-left: 10px; display: none; }
        
        /* Bot√≥n Grande Cerrar Jornada (Estilo nuevo) */
        .btn-close-round { 
            background: linear-gradient(45deg, #ff5e00, #ff9100) !important; 
            color: white !important; font-weight: 800 !important; border: none !important; 
            padding: 20px !important; width: 100% !important; margin-top: 10px !important;
            border-radius: 12px !important; font-size: 1.2rem !important; cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 94, 0, 0.3);
        }
        .btn-close-round:hover { transform: scale(1.02); }
    </style>
</head>
<body>

    <div class="bg-image"></div>
    <div class="bg-overlay"></div>

    <nav class="navbar">
        <div class="nav-logo" style="color: #ff5e00; padding-left: 20px;">
            <i class="fa-solid fa-user-secret"></i> ZONA <span>ADMIN</span>
        </div>
        <div class="nav-links" style="padding-right: 20px;">
            <a href="../docs/home.html" style="background: rgba(255,255,255,0.1); border-radius: 20px; padding: 8px 15px; color: white; text-decoration: none;">
                <i class="fa-solid fa-arrow-left"></i> Volver a la Web
            </a>
        </div>
    </nav>

    <div class="admin-container">
        
        <div class="admin-section">
            <h2><i class="fa-solid fa-person-running"></i> Gesti√≥n de Atletas</h2>
            <div class="edit-controls">
                <div style="flex-grow: 1; width: 100%;">
                    <label>Editar atleta:</label>
                    <select id="selectorEditarAtleta"><option value="">Cargando lista...</option></select>
                </div>
                <button type="button" id="btnCargarAtleta" class="btn-action" style="width: auto; margin: 0; background: #333;">Cargar</button>
            </div>
            <form id="formAtleta">
                <input type="hidden" id="atletaIdHidden"><input type="hidden" id="fotoActualHidden"> 
                <div class="form-grid">
                    <div><label>Nombre</label><input type="text" id="atlNombre" required></div>
                    <div><label>Apellidos</label><input type="text" id="atlApellidos" required></div>
                    <div><label>Categor√≠a</label>
                        <select id="atlCategoria" required>
                            <option value="Velocidad corta">Velocidad corta</option>
                            <option value="Velocidad larga">Velocidad larga</option>
                            <option value="Medio Fondo">Medio Fondo</option>
                            <option value="Fondo">Fondo</option>
                            <option value="Saltos">Saltos</option>
                            <option value="Lanzamientos">Lanzamientos</option>
                            <option value="Marcha">Marcha</option>
                            <option value="Combinadas">Combinadas</option>
                        </select>
                    </div>
                    <div><label>Precio (M)</label><input type="number" id="atlPrecio" required></div>
                    <div class="full-width"><label>Pruebas</label><input type="text" id="atlPruebas"></div>
                    <div><label>Nivel</label>
                        <select id="atlCatMarcas">
                            <option value="Senior">Senior</option>
                            <option value="u23">u23</option>
                            <option value="u20">u20</option>
                            <option value="u18">u18</option>
                            <option value="Master">Master</option>
                        </select>
                    </div>
                    <div class="full-width"><label>Foto</label><input type="file" id="atlFotoInput"></div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="btnSubmitAtleta" class="btn-action">GUARDAR</button>
                    <button type="button" id="btnBorrarAtleta" class="btn-action btn-delete"><i class="fa-solid fa-trash"></i></button>
                    <button type="button" id="btnCancelarEdicion" class="btn-action btn-secondary" style="display:none; background: #666;">CANCELAR</button>
                </div>
            </form>
        </div>

        <div class="admin-section">
            <h2><i class="fa-solid fa-trophy"></i> Editar Competici√≥n</h2>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">Aqu√≠ creas la competici√≥n y a√±ades los resultados. Para repartir puntos ve abajo.</p>
            
            <div class="edit-controls" style="border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 20px;">
                <div style="flex-grow: 1; width: 100%;">
                    <label>Editar competici√≥n:</label>
                    <select id="selectorEditarCompe"><option value="">Cargando lista...</option></select>
                </div>
                <button type="button" id="btnCargarCompe" class="btn-action" style="width: auto; margin: 0; background: #333;">Cargar</button>
            </div>
            
            <form id="formCompe">
                <input type="hidden" id="compeIdHidden"> 
                <div class="form-grid">
                    <div class="full-width"><label>Nombre</label><input type="text" id="compNombre" required></div>
                    <div><label>Fecha</label><input type="date" id="compFecha" required></div>
                    <div><label>Lugar</label><input type="text" id="compLugar" required></div>
                    <div class="full-width"><label>Estado</label>
                        <select id="compEstado">
                            <option value="pendiente">Pendiente (A√∫n no puntuada)</option>
                            <option value="finalizada">Finalizada (Ya puntuada)</option>
                        </select>
                    </div>
                    <div class="full-width"><label>Pruebas (Resumen)</label><input type="text" id="compPruebas" placeholder="Ej: 100m, Longitud..."></div>
                    <div class="full-width"><label>Links</label><input type="text" id="compLinks"></div>
                </div>

                <hr style="border-color: #333; margin: 30px 0;">
                <h3 style="color:white; font-size: 1.1rem; margin-bottom: 15px;">Participantes y Resultados</h3>
                
                <div class="form-grid" style="align-items: end; background: #222; padding: 15px; border-radius: 8px;">
                    <div class="full-width"><label>A√±adir Atleta</label><select id="selectorAtletasLineup"><option value="">Cargando...</option></select></div>
                    <div><label>Prueba</label><input type="text" id="inputPruebaEspecifica" placeholder="Ej: 100m"></div>
                    <div><button type="button" id="btnAddLineup" class="btn-action" style="margin: 0; background: #444;">+ A√ëADIR</button></div>
                </div>

                <div id="listaVisual" class="lineup-box"><p style="color: #666; text-align: center;">Lista vac√≠a.</p></div>

                <div style="display: flex; gap: 10px; margin-top: 30px; flex-wrap: wrap;">
                    <button type="submit" id="btnSubmitCompe" class="btn-action" style="flex: 1;">GUARDAR DATOS</button>
                    <button type="button" id="btnBorrarCompe" class="btn-action btn-delete" style="width: auto;"><i class="fa-solid fa-trash"></i></button>
                    <button type="button" id="btnCancelarCompe" class="btn-action btn-secondary" style="display:none; background: #666; width:auto;">CANCELAR</button>
                </div>
            </form>
        </div>

        <div class="admin-section" style="border-color: #4cd137;">
            <h2 style="color: #4cd137; border-color: #4cd137;"><i class="fa-solid fa-calculator"></i> Cierre de Jornada</h2>
            <p style="color: #ccc; margin-bottom: 20px;">
                Selecciona las competiciones que forman parte de esta jornada (ej: S√°bado + Domingo). 
                Se sumar√°n los puntos de todas y se repartir√°n a los usuarios.
            </p>

            <div id="checklistCompes" class="checklist-container">
                <p style="color:#666; text-align:center;">Cargando competiciones pendientes...</p>
            </div>

            <button type="button" id="btnCerrarJornadaGlobal" class="btn-close-round">
                REPARTIR PUNTOS Y CERRAR JORNADA
            </button>
        </div>

    </div>

    <script type="module">
        import { db, auth } from "../js/firebase-config.js";
        import { collection, addDoc, getDocs, orderBy, query, doc, getDoc, updateDoc, deleteDoc, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // === 1. SEGURIDAD ===
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docRef = doc(db, "usuarios", user.uid);
                const docSnap = await getDoc(docRef);
                const userData = docSnap.exists() ? docSnap.data() : null;
                if (userData && userData.rol === "admin") {
                    initAdmin();
                } else {
                    document.body.innerHTML = "<h1>‚õî ACCESO DENEGADO</h1>";
                    setTimeout(() => window.location.href = "../docs/home.html", 1500);
                }
            } else {
                window.location.href = "../index.html";
            }
        });

        async function initAdmin() {
            cargarSelectoresAtletas();
            cargarSelectorCompes();
            cargarCheckboxesPendientes(); // Nueva funci√≥n para la zona de abajo
        }

        let listaParticipantes = []; 

        async function cargarSelectoresAtletas() {
            const selEdit = document.getElementById('selectorEditarAtleta');
            const selLineup = document.getElementById('selectorAtletasLineup');
            const q = query(collection(db, "atletas"), orderBy("nombre"));
            const snap = await getDocs(q);
            let html = '<option value="">-- Selecciona Atleta --</option>';
            snap.forEach((doc) => {
                const data = doc.data();
                const safeData = JSON.stringify(data).replace(/"/g, '&quot;');
                html += `<option value="${doc.id}" data-info="${safeData}">${data.nombre} ${data.apellidos}</option>`;
            });
            selEdit.innerHTML = html;
            selLineup.innerHTML = html;
        }

        async function cargarSelectorCompes() {
            const selCompe = document.getElementById('selectorEditarCompe');
            const q = query(collection(db, "competiciones"), orderBy("fecha", "desc"));
            const snap = await getDocs(q);
            let html = '<option value="">-- Selecciona para Editar --</option>';
            snap.forEach((doc) => {
                const data = doc.data();
                const safeData = JSON.stringify(data).replace(/"/g, '&quot;');
                // Marcamos visualmente si ya est√° finalizada
                const estado = data.estado === 'finalizada' ? '‚úÖ' : '‚è≥';
                html += `<option value="${doc.id}" data-info="${safeData}">${estado} ${data.fecha} - ${data.nombre}</option>`;
            });
            selCompe.innerHTML = html;
        }

        // === NUEVA FUNCI√ìN: CARGAR CHECKBOXES PARA CIERRE ===
        async function cargarCheckboxesPendientes() {
            const container = document.getElementById('checklistCompes');
            // Solo queremos las pendientes
            const q = query(collection(db, "competiciones"), where("estado", "==", "pendiente"), orderBy("fecha", "asc"));
            const snap = await getDocs(q);
            
            if(snap.empty) {
                container.innerHTML = '<p style="color:#888; text-align:center;">No hay competiciones pendientes.</p>';
                document.getElementById('btnCerrarJornadaGlobal').disabled = true;
                document.getElementById('btnCerrarJornadaGlobal').style.opacity = "0.5";
                return;
            }

            let html = '';
            snap.forEach(doc => {
                const d = doc.data();
                // Checkbox con value = ID de la competici√≥n
                // data-json para acceder a sus participantes luego
                const jsonParticipantes = JSON.stringify(d.participantes || []).replace(/"/g, '&quot;');
                
                html += `
                    <div class="check-item">
                        <label>
                            <span>
                                <input type="checkbox" class="comp-checkbox" value="${doc.id}" data-participantes="${jsonParticipantes}">
                                ${d.nombre}
                            </span>
                            <span class="check-date">${d.fecha}</span>
                        </label>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // --- GESTI√ìN ATLETAS (IGUAL QUE ANTES) ---
        document.getElementById('atlFotoInput').addEventListener('change', function() { if(this.files[0]) document.getElementById('rutaPreview').innerText = "../images/" + this.files[0].name; });

        document.getElementById('btnCargarAtleta').addEventListener('click', () => {
            const select = document.getElementById('selectorEditarAtleta');
            if(!select.value) return alert("Selecciona atleta");
            const data = JSON.parse(select.options[select.selectedIndex].getAttribute('data-info'));
            document.getElementById('atletaIdHidden').value = select.value;
            document.getElementById('atlNombre').value = data.nombre;
            document.getElementById('atlApellidos').value = data.apellidos;
            document.getElementById('atlCategoria').value = data.categoria;
            document.getElementById('atlPrecio').value = data.precio;
            document.getElementById('atlPruebas').value = data.pruebas_principales || "";
            document.getElementById('atlCatMarcas').value = data.cat_marcas || "u23";
            document.getElementById('fotoActualHidden').value = data.foto;
            document.getElementById('btnCancelarEdicion').style.display = 'block';
            document.getElementById('btnBorrarAtleta').style.display = 'block';
        });

        document.getElementById('formAtleta').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('atletaIdHidden').value;
            const fileInput = document.getElementById('atlFotoInput');
            let rutaFoto = id ? document.getElementById('fotoActualHidden').value : "";
            if (fileInput.files.length > 0) rutaFoto = "../images/" + fileInput.files[0].name;
            const datos = {
                nombre: document.getElementById('atlNombre').value,
                apellidos: document.getElementById('atlApellidos').value,
                categoria: document.getElementById('atlCategoria').value,
                precio: Number(document.getElementById('atlPrecio').value),
                pruebas_principales: document.getElementById('atlPruebas').value,
                cat_marcas: document.getElementById('atlCatMarcas').value,
                foto: rutaFoto
            };
            if(id) await updateDoc(doc(db, "atletas", id), datos);
            else { datos.puntos = 0; await addDoc(collection(db, "atletas"), datos); }
            alert("Atleta Guardado!"); window.location.reload();
        });

        // --- GESTI√ìN COMPETICIONES (IGUAL, PERO SIN BOT√ìN CERRAR DENTRO) ---
        document.getElementById('btnCargarCompe').addEventListener('click', () => {
            const select = document.getElementById('selectorEditarCompe');
            if(!select.value) return alert("Selecciona competici√≥n");
            const data = JSON.parse(select.options[select.selectedIndex].getAttribute('data-info'));
            document.getElementById('compeIdHidden').value = select.value;
            document.getElementById('compNombre').value = data.nombre;
            document.getElementById('compFecha').value = data.fecha;
            document.getElementById('compLugar').value = data.lugar;
            document.getElementById('compEstado').value = data.estado || "pendiente";
            document.getElementById('compLinks').value = data.links || "";
            document.getElementById('compPruebas').value = data.pruebas_resumen || "";
            listaParticipantes = data.participantes || [];
            actualizarVisualCompe();
            document.getElementById('btnCancelarCompe').style.display = 'block';
            document.getElementById('btnBorrarCompe').style.display = 'block';
        });

        document.getElementById('btnAddLineup').addEventListener('click', () => {
            const selector = document.getElementById('selectorAtletasLineup');
            const prueba = document.getElementById('inputPruebaEspecifica').value;
            if (!selector.value || !prueba) return alert("Faltan datos");
            listaParticipantes.push({
                id_atleta: selector.value,
                nombre_completo: selector.options[selector.selectedIndex].text.trim(),
                prueba: prueba,
                resultado: "", puntos: 0
            });
            actualizarVisualCompe();
        });

        function actualizarVisualCompe() {
            const container = document.getElementById('listaVisual');
            container.innerHTML = listaParticipantes.length ? "" : '<p style="color:#666;text-align:center;">Lista vac√≠a.</p>';
            listaParticipantes.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'lineup-item';
                div.dataset.id = item.id_atleta; 
                div.style.cssText = "display:flex; align-items:center; gap:10px; border-bottom:1px solid #333; padding:5px; margin-bottom:5px;";
                div.innerHTML = `
                    <div style="flex-grow:1;"><strong>${item.nombre_completo}</strong> <span style="font-size:0.8rem;color:#888;">(${item.prueba})</span></div>
                    <input type="text" class="result-text" placeholder="Marca (1¬∫)" value="${item.resultado || ''}" oninput="window.listaParticipantes[${index}].resultado = this.value">
                    <input type="number" class="result-points" placeholder="Pts" value="${item.puntos || 0}" oninput="window.listaParticipantes[${index}].puntos = Number(this.value)">
                    <i class="fa-solid fa-trash" style="color:red; cursor:pointer;" onclick="delLineup(${index})"></i>
                `;
                container.appendChild(div);
            });
            window.listaParticipantes = listaParticipantes;
        }
        
        window.delLineup = (i) => { listaParticipantes.splice(i, 1); actualizarVisualCompe(); };

        // Guardado de la competici√≥n (s√≥lo guarda datos, NO cierra jornada)
        document.getElementById('formCompe').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('compeIdHidden').value;
            // Recoger datos actuales del DOM
            const itemsDOM = document.querySelectorAll('.lineup-item');
            const listaActualizada = [];
            itemsDOM.forEach(div => {
                const inputs = div.querySelectorAll('input');
                const original = listaParticipantes.find(p => p.id_atleta === div.dataset.id);
                listaActualizada.push({ ...original, resultado: inputs[0].value, puntos: Number(inputs[1].value) });
            });

            const datos = {
                nombre: document.getElementById('compNombre').value,
                fecha: document.getElementById('compFecha').value,
                lugar: document.getElementById('compLugar').value,
                estado: document.getElementById('compEstado').value,
                links: document.getElementById('compLinks').value,
                pruebas_resumen: document.getElementById('compPruebas').value,
                participantes: listaActualizada
            };

            if(id) await updateDoc(doc(db, "competiciones", id), datos);
            else await addDoc(collection(db, "competiciones"), datos);
            
            alert("‚úÖ Competici√≥n guardada (No cerrada)."); window.location.reload();
        });

        // ================================================================
        // === NUEVA L√ìGICA: CERRAR JORNADA (MULTI COMPETICI√ìN) ===
        // ================================================================
        document.getElementById('btnCerrarJornadaGlobal').addEventListener('click', async () => {
            // 1. Obtener checkboxes seleccionados
            const checkboxes = document.querySelectorAll('.comp-checkbox:checked');
            if(checkboxes.length === 0) return alert("‚ùå Selecciona al menos una competici√≥n.");

            if(!confirm(`‚ö†Ô∏è VAS A CERRAR ${checkboxes.length} COMPETICIONES.\n\nEsto sumar√° puntos a los usuarios y bloquear√° estas competiciones. ¬øSeguro?`)) return;

            const btn = document.getElementById('btnCerrarJornadaGlobal');
            btn.innerText = "PROCESANDO PUNTOS...";
            btn.disabled = true;

            try {
                // 2. Crear Mapa Global de Puntos (ID_Atleta -> Puntos Totales)
                const mapaPuntosGlobal = {}; // { 'id123': 25, 'id456': 10 }
                const competicionesIds = [];

                // Recorremos cada competici√≥n seleccionada
                checkboxes.forEach(cb => {
                    competicionesIds.push(cb.value);
                    const participantes = JSON.parse(cb.dataset.participantes);
                    
                    participantes.forEach(p => {
                        const pts = Number(p.puntos) || 0;
                        if(pts > 0) {
                            if(mapaPuntosGlobal[p.id_atleta]) {
                                mapaPuntosGlobal[p.id_atleta] += pts; // Sumar si compite 2 veces
                            } else {
                                mapaPuntosGlobal[p.id_atleta] = pts;
                            }
                        }
                    });
                });

                console.log("Mapa de puntos a repartir:", mapaPuntosGlobal);

                // 3. Repartir a Usuarios (Batching no necesario para lectura, s√≠ para escritura si son muchos, pero haremos loop simple por seguridad)
                const usersSnap = await getDocs(collection(db, "usuarios"));
                let usuariosAfectados = 0;
                
                // Usamos Promise.all para velocidad
                const promesasUsuarios = usersSnap.docs.map(async (userDoc) => {
                    const u = userDoc.data();
                    const equipo = u.equipo || [];
                    
                    if(equipo.length !== 3) return; // Equipo incompleto no punt√∫a

                    let puntosSumar = 0;
                    equipo.forEach(atletaId => {
                        const idLimpia = String(atletaId).trim();
                        if (mapaPuntosGlobal[idLimpia]) {
                            let pts = mapaPuntosGlobal[idLimpia];
                            // Capit√°n x1.5
                            if (idLimpia === String(u.capitanId).trim()) pts = pts * 1.5; 
                            puntosSumar += pts;
                        }
                    });

                    if(puntosSumar > 0) {
                        usuariosAfectados++;
                        const puntosActuales = Number(u.puntos_total) || 0;
                        await updateDoc(doc(db, "usuarios", userDoc.id), {
                            puntos_total: puntosActuales + puntosSumar,
                            puntos_ultima_jornada: puntosSumar
                        });
                    }
                });

                await Promise.all(promesasUsuarios);

                // 4. Actualizar Precio Atletas (Basado en el total del finde)
                // Recorremos los IDs que han puntuado
                const promesasAtletas = Object.keys(mapaPuntosGlobal).map(async (idAtleta) => {
                    const pts = mapaPuntosGlobal[idAtleta];
                    const atlRef = doc(db, "atletas", idAtleta);
                    const atlSnap = await getDoc(atlRef);
                    
                    if (atlSnap.exists()) {
                        const ad = atlSnap.data();
                        let nuevoPrecio = ad.precio;
                        // Regla simple de mercado
                        if (pts >= 30) nuevoPrecio += 1;
                        if (pts <= 5 && nuevoPrecio > 1) nuevoPrecio -= 1;

                        await updateDoc(atlRef, {
                            puntos: (Number(ad.puntos) || 0) + pts,
                            puntos_ultima_jornada: pts,
                            precio: nuevoPrecio
                        });
                    }
                });

                await Promise.all(promesasAtletas);

                // 5. Marcar Competiciones como FINALIZADAS
                const promesasCompes = competicionesIds.map(async (idCompe) => {
                    await updateDoc(doc(db, "competiciones", idCompe), { estado: "finalizada" });
                });

                await Promise.all(promesasCompes);

                alert(`üèÜ ¬°JORNADA CERRADA CON √âXITO!\n\n- Competiciones cerradas: ${competicionesIds.length}\n- Managers actualizados: ${usuariosAfectados}`);
                window.location.reload();

            } catch (error) {
                console.error(error);
                alert("Error cr√≠tico cerrando jornada: " + error.message);
                btn.disabled = false;
                btn.innerText = "REINTENTAR";
            }
        });

    </script>
</body>
</html>