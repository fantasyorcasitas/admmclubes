<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin | Fantasy Track</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ESTILOS EXTRA ESPECÍFICOS PARA EL ADMIN */
        html, body { overflow-y: auto !important; height: auto !important; min-height: 100vh; }
        .admin-container { padding-top: 130px !important; padding-bottom: 100px !important; max-width: 1000px; margin: 0 auto; position: relative; z-index: 10; }
        .navbar { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background: #000; border-bottom: 2px solid var(--primary); }
        
        /* Ajustes inputs admin */
        select, input { background: #111 !important; color: white !important; border: 1px solid #555 !important; }
        .result-text { background: #000 !important; border: 1px solid #444 !important; color: #ccc !important; width: 140px; padding: 5px; border-radius: 4px; text-align: center; }
        .result-points { background: #000 !important; border: 1px solid var(--primary) !important; color: var(--primary) !important; width: 70px; padding: 5px; border-radius: 4px; font-weight: bold; text-align: center; }
        
        .btn-delete { background: #d63031 !important; color: white !important; border: none !important; margin-left: 10px; display: none; }
        
        /* Botón Grande Cerrar Jornada (Estilo nuevo) */
        .btn-close-round { 
            background: linear-gradient(45deg, #ff5e00, #ff9100) !important; 
            color: white !important; font-weight: 800 !important; border: none !important; 
            padding: 20px !important; width: 100% !important; margin-top: 10px !important;
            border-radius: 12px !important; font-size: 1.2rem !important; cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 94, 0, 0.3);
        }
        .btn-close-round:hover { transform: scale(1.02); }
    </style>
</head>
<body>

    <div class="bg-image"></div>
    <div class="bg-overlay"></div>

    <nav class="navbar">
        <div class="nav-logo" style="color: #ff5e00; padding-left: 20px;">
            <i class="fa-solid fa-user-secret"></i> ZONA <span>ADMIN</span>
        </div>
        <div class="nav-links" style="padding-right: 20px;">
            <a href="../docs/home.html" style="background: rgba(255,255,255,0.1); border-radius: 20px; padding: 8px 15px; color: white; text-decoration: none;">
                <i class="fa-solid fa-arrow-left"></i> Volver a la Web
            </a>
        </div>
    </nav>

    <div class="admin-container">
        
        <div class="admin-section">
            <h2><i class="fa-solid fa-person-running"></i> Gestión de Atletas</h2>
            <div class="edit-controls">
                <div style="flex-grow: 1; width: 100%;">
                    <label>Editar atleta:</label>
                    <select id="selectorEditarAtleta"><option value="">Cargando lista...</option></select>
                </div>
                <button type="button" id="btnCargarAtleta" class="btn-action" style="width: auto; margin: 0; background: #333;">Cargar</button>
            </div>
            <form id="formAtleta">
    <input type="hidden" id="atletaIdHidden">
    <input type="hidden" id="fotoActualHidden"> 
    
    <div class="form-grid">
        <div><label>Nombre</label><input type="text" id="atlNombre" required></div>
        <div><label>Apellidos</label><input type="text" id="atlApellidos" required></div>
        
        <div><label>Categoría (General)</label>
            <select id="atlCategoria" required>
                <option value="Velocidad corta">Velocidad corta</option>
                <option value="Velocidad larga">Velocidad larga</option>
                <option value="Medio Fondo">Medio Fondo</option>
                <option value="Fondo">Fondo</option>
                <option value="Saltos">Saltos</option>
                <option value="Lanzamientos">Lanzamientos</option>
                <option value="Marcha">Marcha</option>
                <option value="Combinadas">Combinadas</option>
            </select>
        </div>

        <div><label>Precio (M)</label><input type="number" id="atlPrecio" required></div>

        <div style="grid-column: span 2; background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <p style="grid-column: span 2; margin: 0 0 10px 0; color: #ff5e00; font-weight: bold; border-bottom: 1px solid #444;">DATOS TÉCNICOS</p>
            
            <div><label>Marca Personal (MMP)</label><input type="text" id="atlMarcaPersonal" placeholder="Ej: 10.55"></div>
            <div><label>Posición Esperada</label><input type="number" id="atlPosicionEsperada" placeholder="Ej: 1"></div>
            
            <div><label>Fecha Última Compe</label><input type="date" id="atlFechaUltima"></div>
            <div><label>Marca Última Compe</label><input type="text" id="atlMarcaUltima" placeholder="Ej: 10.60 (-0.5)"></div>
        </div>
        <div class="full-width"><label>Pruebas Específicas</label><input type="text" id="atlPruebas" placeholder="Ej: 400m"></div>
        
        <div><label>Nivel</label>
            <select id="atlCatMarcas">
                <option value="Senior">Senior</option>
                <option value="u23">u23</option>
                <option value="u20">u20</option>
                <option value="u18">u18</option>
                <option value="Master">Master</option>
            </select>
        </div>
        
        <div class="full-width"><label>Foto</label><input type="file" id="atlFotoInput"></div>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button type="submit" id="btnSubmitAtleta" class="btn-action">GUARDAR ATLETA</button>
        <button type="button" id="btnBorrarAtleta" class="btn-action btn-delete" style="display:none;"><i class="fa-solid fa-trash"></i></button>
        <button type="button" id="btnCancelarEdicion" class="btn-action btn-secondary" style="display:none; background: #666;">CANCELAR</button>
    </div>
</form>

        <div class="admin-section">
            <h2><i class="fa-solid fa-trophy"></i> Editar Competición</h2>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">Aquí creas la competición y añades los resultados. Para repartir puntos ve abajo.</p>
            
            <div class="edit-controls" style="border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 20px;">
                <div style="flex-grow: 1; width: 100%;">
                    <label>Editar competición:</label>
                    <select id="selectorEditarCompe"><option value="">Cargando lista...</option></select>
                </div>
                <button type="button" id="btnCargarCompe" class="btn-action" style="width: auto; margin: 0; background: #333;">Cargar</button>
            </div>
            
            <form id="formCompe">
                <input type="hidden" id="compeIdHidden"> 
                <div class="form-grid">
                    <div class="full-width"><label>Nombre</label><input type="text" id="compNombre" required></div>
                    <div><label>Fecha</label><input type="date" id="compFecha" required></div>
                    <div><label>Lugar</label><input type="text" id="compLugar" required></div>
                    <div class="full-width"><label>Estado</label>
                        <select id="compEstado">
                            <option value="pendiente">Pendiente (Aún no puntuada)</option>
                            <option value="finalizada">Finalizada (Ya puntuada)</option>
                        </select>
                    </div>
                    <div class="full-width"><label>Pruebas (Resumen)</label><input type="text" id="compPruebas" placeholder="Ej: 100m, Longitud..."></div>
                    <div class="full-width"><label>Links</label><input type="text" id="compLinks"></div>
                </div>

                <hr style="border-color: #333; margin: 30px 0;">
                <h3 style="color:white; font-size: 1.1rem; margin-bottom: 15px;">Participantes y Resultados</h3>
                
                <div class="form-grid" style="align-items: end; background: #222; padding: 15px; border-radius: 8px;">
    <div class="full-width">
        <label>Añadir Atleta</label>
        <select id="selectorAtletasLineup"><option value="">Cargando...</option></select>
    </div>
    
    <div>
        <label>Prueba</label>
        <input type="text" id="inputPruebaEspecifica" placeholder="Ej: 100m">
    </div>

    <div>
        <label>Marca Personal</label>
        <input type="text" id="inputMarcaPersonal" placeholder="Ej: 10.55">
    </div>

    <div>
        <label>Pos. Esperada</label>
        <input type="number" id="inputPosicionEsperada" placeholder="Ej: 1">
    </div>

    <div>
        <button type="button" id="btnAddLineup" class="btn-action" style="margin: 0; background: #444;">+ AÑADIR</button>
    </div>
</div>

<div id="listaVisual" class="lineup-box"><p style="color: #666; text-align: center;">Lista vacía.</p></div>

                <div id="listaVisual" class="lineup-box"><p style="color: #666; text-align: center;">Lista vacía.</p></div>

                <div style="display: flex; gap: 10px; margin-top: 30px; flex-wrap: wrap;">
                    <button type="submit" id="btnSubmitCompe" class="btn-action" style="flex: 1;">GUARDAR DATOS</button>
                    <button type="button" id="btnBorrarCompe" class="btn-action btn-delete" style="width: auto;"><i class="fa-solid fa-trash"></i></button>
                    <button type="button" id="btnCancelarCompe" class="btn-action btn-secondary" style="display:none; background: #666; width:auto;">CANCELAR</button>
                </div>
            </form>
        </div>

        <div class="admin-section" style="border-color: #4cd137;">
            <h2 style="color: #4cd137; border-color: #4cd137;"><i class="fa-solid fa-calculator"></i> Cierre de Jornada</h2>
            <p style="color: #ccc; margin-bottom: 20px;">
                Selecciona las competiciones que forman parte de esta jornada (ej: Sábado + Domingo). 
                Se sumarán los puntos de todas y se repartirán a los usuarios.
            </p>

            <div id="checklistCompes" class="checklist-container">
                <p style="color:#666; text-align:center;">Cargando competiciones pendientes...</p>
            </div>

            <button type="button" id="btnCerrarJornadaGlobal" class="btn-close-round">
                REPARTIR PUNTOS Y CERRAR JORNADA
            </button>
        </div>

    </div>

    <script type="module">
    import { db, auth } from "../js/firebase-config.js"; 
    import { 
        collection, addDoc, getDocs, orderBy, query, doc, getDoc, updateDoc, deleteDoc, where 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Variables globales
    let listaParticipantes = []; 
    window.listaParticipantes = listaParticipantes; 

    // === SEGURIDAD ===
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const docRef = doc(db, "usuarios", user.uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists() && docSnap.data().rol === "admin") {
                initAdmin();
            } else {
                document.body.innerHTML = "<h1>⛔ ACCESO DENEGADO</h1>";
                setTimeout(() => window.location.href = "../docs/home.html", 1500);
            }
        } else {
            window.location.href = "../index.html";
        }
    });

    async function initAdmin() {
        console.log("Iniciando Admin...");
        cargarSelectoresAtletas();
        cargarSelectorCompes();
        cargarCheckboxesPendientes();
    }

    // =============================================================
    // 1. LÓGICA DE ATLETAS (SOLUCIÓN A TU PROBLEMA DE GUARDADO)
    // =============================================================

    // --- CARGAR DATOS AL EDITAR ---
    document.getElementById('btnCargarAtleta').addEventListener('click', () => {
        const select = document.getElementById('selectorEditarAtleta');
        if(!select.value) return alert("Selecciona un atleta.");
        
        // Obtenemos los datos completos del atributo data-info
        const data = JSON.parse(select.options[select.selectedIndex].getAttribute('data-info'));
        console.log("Cargando datos:", data); // Para depurar

        document.getElementById('atletaIdHidden').value = select.value;
        document.getElementById('atlNombre').value = data.nombre;
        document.getElementById('atlApellidos').value = data.apellidos;
        document.getElementById('atlCategoria').value = data.categoria;
        document.getElementById('atlPrecio').value = data.precio;
        document.getElementById('atlPruebas').value = data.pruebas_principales || "";
        document.getElementById('atlCatMarcas').value = data.cat_marcas || "u23";
        
        // CARGA DE CAMPOS ESPECÍFICOS (Asegurando que coinciden con los IDs del HTML)
        document.getElementById('atlMarcaPersonal').value = data.marca_personal || "";
        document.getElementById('atlPosicionEsperada').value = data.posicion_esperada || "";
        document.getElementById('atlFechaUltima').value = data.fecha_ultima_competicion || "";
        document.getElementById('atlMarcaUltima').value = data.marca_ultima_competicion || "";

        document.getElementById('fotoActualHidden').value = data.foto || "";
        
        // Mostrar botones ocultos
        document.getElementById('btnCancelarEdicion').style.display = 'block';
        document.getElementById('btnBorrarAtleta').style.display = 'block';
    });

    // --- GUARDAR (SUBMIT) ---
    document.getElementById('formAtleta').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnSubmitAtleta');
        btn.disabled = true;
        btn.innerText = "Procesando...";

        try {
            const id = document.getElementById('atletaIdHidden').value;
            const precio = Number(document.getElementById('atlPrecio').value);
            const fileInput = document.getElementById('atlFotoInput');
            
            // Foto
            let rutaFoto = id ? document.getElementById('fotoActualHidden').value : "https://cdn-icons-png.flaticon.com/512/74/74472.png";
            if (fileInput.files.length > 0) rutaFoto = "../images/" + fileInput.files[0].name;

            // Recoger valores de los inputs nuevos MANUALMENTE para asegurar
            const mp = document.getElementById('atlMarcaPersonal').value;
            const pos = document.getElementById('atlPosicionEsperada').value;
            const fecha = document.getElementById('atlFechaUltima').value;
            const mUltima = document.getElementById('atlMarcaUltima').value;

            // Construir objeto
            const datos = {
                nombre: document.getElementById('atlNombre').value,
                apellidos: document.getElementById('atlApellidos').value,
                categoria: document.getElementById('atlCategoria').value,
                precio: precio,
                pruebas_principales: document.getElementById('atlPruebas').value,
                cat_marcas: document.getElementById('atlCatMarcas').value,
                foto: rutaFoto,
                
                // AQUÍ ESTÁN LOS CAMPOS QUE NO SE GUARDABAN:
                marca_personal: mp,
                posicion_esperada: Number(pos) || 0,
                fecha_ultima_competicion: fecha,
                marca_ultima_competicion: mUltima
            };

            console.log("Enviando a Firebase:", datos); // MIRA LA CONSOLA SI FALLA

            if (id) {
                // ACTUALIZAR
                await updateDoc(doc(db, "atletas", id), datos);
                alert("✅ Datos actualizados correctamente en Firebase.");
            } else {
                // CREAR
                datos.puntos = 0;
                datos.tendencia = "neutral";
                datos.historial_puntos = [];
                datos.historial_valor = [precio];
                await addDoc(collection(db, "atletas"), datos);
                alert("✅ Nuevo atleta creado correctamente.");
            }

            window.location.reload(); 

        } catch (error) {
            console.error("ERROR AL GUARDAR:", error);
            alert("Error crítico al guardar: " + error.message);
            btn.disabled = false;
            btn.innerText = "GUARDAR ATLETA";
        }
    });

    // =============================================================
    // RESTO DE FUNCIONES (SELECTORES, COMPETICIONES, ETC.)
    // =============================================================
    async function cargarSelectoresAtletas() {
        try {
            const q = query(collection(db, "atletas"), orderBy("nombre"));
            const snap = await getDocs(q);
            let html = '<option value="">-- Selecciona Atleta --</option>';
            snap.forEach((doc) => {
                const d = doc.data();
                const safeData = JSON.stringify(d).replace(/"/g, '&quot;');
                html += `<option value="${doc.id}" data-info="${safeData}">${d.nombre} ${d.apellidos}</option>`;
            });
            document.getElementById('selectorEditarAtleta').innerHTML = html;
            document.getElementById('selectorAtletasLineup').innerHTML = html;
        } catch(e) { console.error(e); }
    }

    async function cargarSelectorCompes() {
        try {
            const q = query(collection(db, "competiciones"), orderBy("fecha", "desc"));
            const snap = await getDocs(q);
            let html = '<option value="">-- Selecciona --</option>';
            snap.forEach((doc) => {
                const d = doc.data();
                const safeData = JSON.stringify(d).replace(/"/g, '&quot;');
                const estado = d.estado === 'finalizada' ? '✅' : '⏳';
                html += `<option value="${doc.id}" data-info="${safeData}">${estado} ${d.fecha} - ${d.nombre}</option>`;
            });
            document.getElementById('selectorEditarCompe').innerHTML = html;
        } catch(e) { console.error(e); }
    }

    // --- COMPETICIONES ---
    document.getElementById('btnCargarCompe').addEventListener('click', () => {
        const select = document.getElementById('selectorEditarCompe');
        if(!select.value) return alert("Selecciona una competición");
        const data = JSON.parse(select.options[select.selectedIndex].getAttribute('data-info'));
        
        document.getElementById('compeIdHidden').value = select.value;
        document.getElementById('compNombre').value = data.nombre;
        document.getElementById('compFecha').value = data.fecha;
        document.getElementById('compLugar').value = data.lugar;
        document.getElementById('compEstado').value = data.estado || "pendiente";
        document.getElementById('compLinks').value = data.links || "";
        document.getElementById('compPruebas').value = data.pruebas_resumen || "";
        
        window.listaParticipantes = data.participantes || [];
        actualizarVisualCompe();
        document.getElementById('btnCancelarCompe').style.display = 'block';
        document.getElementById('btnBorrarCompe').style.display = 'block';
    });

    document.getElementById('btnAddLineup').addEventListener('click', () => {
        const selector = document.getElementById('selectorAtletasLineup');
        const prueba = document.getElementById('inputPruebaEspecifica').value;
        if (!selector.value || !prueba) return alert("Falta Atleta o Prueba");

        window.listaParticipantes.push({
            id_atleta: selector.value,
            nombre_completo: selector.options[selector.selectedIndex].text,
            prueba: prueba,
            resultado: "",
            puntos: 0
        });
        document.getElementById('inputPruebaEspecifica').value = "";
        actualizarVisualCompe();
    });

    function actualizarVisualCompe() {
        const container = document.getElementById('listaVisual');
        container.innerHTML = window.listaParticipantes.length ? "" : '<p style="color:#666;text-align:center;">Lista vacía.</p>';
        window.listaParticipantes.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'lineup-item';
            div.dataset.id = item.id_atleta;
            div.style.cssText = "display:flex; align-items:center; gap:10px; border-bottom:1px solid #333; padding:10px; background:#151515; margin-bottom:5px;";
            div.innerHTML = `
                <div style="flex-grow:1;"><strong style="color:white;">${item.nombre_completo}</strong> <span style="color:#888;">(${item.prueba})</span></div>
                <input type="text" class="result-text" value="${item.resultado||''}" oninput="window.listaParticipantes[${index}].resultado=this.value">
                <input type="number" class="result-points" value="${item.puntos||0}" oninput="window.listaParticipantes[${index}].puntos=Number(this.value)">
                <i class="fa-solid fa-trash" style="color:red; cursor:pointer;" onclick="delLineup(${index})"></i>
            `;
            container.appendChild(div);
        });
    }
    window.delLineup = (index) => { window.listaParticipantes.splice(index, 1); actualizarVisualCompe(); };

    document.getElementById('formCompe').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnSubmitCompe');
        btn.disabled = true; btn.innerText = "Guardando...";
        try {
            const id = document.getElementById('compeIdHidden').value;
            const domItems = document.querySelectorAll('.lineup-item');
            const listaFinal = [];
            domItems.forEach((div, i) => {
                const inputs = div.querySelectorAll('input');
                listaFinal.push({
                    ...window.listaParticipantes[i],
                    resultado: inputs[0].value,
                    puntos: Number(inputs[1].value)
                });
            });

            const datos = {
                nombre: document.getElementById('compNombre').value,
                fecha: document.getElementById('compFecha').value,
                lugar: document.getElementById('compLugar').value,
                estado: document.getElementById('compEstado').value,
                links: document.getElementById('compLinks').value,
                pruebas_resumen: document.getElementById('compPruebas').value,
                participantes: listaFinal
            };

            if(id) await updateDoc(doc(db, "competiciones", id), datos);
            else await addDoc(collection(db, "competiciones"), datos);
            
            alert("✅ Competición guardada.");
            window.location.reload();
        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
            btn.disabled = false;
        }
    });

    // --- CIERRE JORNADA ---
    async function cargarCheckboxesPendientes() {
        const container = document.getElementById('checklistCompes');
        try {
            const q = query(collection(db, "competiciones"), orderBy("fecha", "asc"));
            const snap = await getDocs(q);
            let html = '';
            let hay = false;
            snap.forEach(doc => {
                const d = doc.data();
                if(d.estado === 'pendiente') {
                    hay = true;
                    const json = JSON.stringify(d.participantes || []).replace(/"/g, '&quot;');
                    html += `<div class="check-item"><label style="display:flex;align-items:center;cursor:pointer;"><input type="checkbox" class="comp-checkbox" value="${doc.id}" data-parts="${json}" style="margin-right:10px;"><span style="color:white;">${d.nombre}</span></label></div>`;
                }
            });
            container.innerHTML = hay ? html : '<p style="color:#666;text-align:center">No hay pendientes.</p>';
            if(!hay && document.getElementById('btnCerrarJornadaGlobal')) document.getElementById('btnCerrarJornadaGlobal').disabled = true;
        } catch(e) { console.error(e); }
    }

    document.getElementById('btnCerrarJornadaGlobal').addEventListener('click', async () => {
        if(!confirm("¿Cerrar jornada?")) return;
        const checks = document.querySelectorAll('.comp-checkbox:checked');
        const btn = document.getElementById('btnCerrarJornadaGlobal');
        btn.disabled = true; btn.innerText = "Procesando...";
        
        try {
            const mapa = {};
            const ids = [];
            checks.forEach(cb => {
                ids.push(cb.value);
                const parts = JSON.parse(cb.getAttribute('data-parts'));
                parts.forEach(p => { 
                    const pts = Number(p.puntos) || 0;
                    if(pts > 0) mapa[p.id_atleta] = (mapa[p.id_atleta] || 0) + pts;
                });
            });

            // Usuarios
            const usrs = await getDocs(collection(db, "usuarios"));
            const promisesU = usrs.docs.map(async uDoc => {
                const u = uDoc.data();
                const eq = u.equipo || [];
                let suma = 0;
                eq.forEach(aid => {
                    let p = mapa[aid] || 0;
                    if(u.capitanId === aid) p *= 1.5;
                    suma += p;
                });
                if(suma > 0) await updateDoc(doc(db, "usuarios", uDoc.id), { puntos_total: (u.puntos_total||0)+suma, puntos_ultima_jornada: suma });
            });
            await Promise.all(promisesU);

            // Atletas
            const promisesA = Object.keys(mapa).map(async aid => {
                const pts = mapa[aid];
                const ref = doc(db, "atletas", aid);
                const snap = await getDoc(ref);
                if(snap.exists()) {
                    const d = snap.data();
                    let np = d.precio;
                    if(pts >= 25) np++;
                    if(pts <= 5 && np > 1) np--;
                    const hp = d.historial_puntos || []; hp.push(pts);
                    const hv = d.historial_valor || []; hv.push(np);
                    await updateDoc(ref, { puntos: (d.puntos||0)+pts, precio: np, historial_puntos: hp, historial_valor: hv });
                }
            });
            await Promise.all(promisesA);

            // Cerrar
            const promisesC = ids.map(id => updateDoc(doc(db, "competiciones", id), { estado: "finalizada" }));
            await Promise.all(promisesC);

            alert("Jornada cerrada");
            window.location.reload();
        } catch(e) { console.error(e); alert("Error: " + e.message); btn.disabled = false; }
    });
</script>
</body>
</html>